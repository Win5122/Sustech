角膜内皮细胞健康状况评估系统
林慧燕王标
一、研究背景
角膜是眼球正前方的半透明部分。它保证外界光线毫无障碍地通过到达眼底，以获得清晰
的成像，角膜病变是全球第4大致盲疾病，据统计，全球累计有2000多万因角膜病致盲的患
者[1]。角膜病患者如得不到及早治疗，角膜可能出现溃疡、穿孔或角膜白斑，导致失明。
角膜内皮细胞是位于角膜后表面紧密排列的不可再生表皮细胞，形状大多为六角形。角膜
内皮细胞层的结构完整和功能健全是维持角膜透明和正常生理作用的重要因素。角膜内皮细胞
健康状况的评估依赖于相关的临床参数量化，比如，内皮细胞密度(ECD)、多晶性(或细胞大小
的变化系数，CV)和多构形(或六角形细胞的百分比，HEX)等[2]。然而，手动分割角膜内皮细
胞图像并估计相关参数费时费力。因此，自动化的角膜细胞健康状况评估系统，能够大大降低
临床医生的工作量，对于角膜相关角膜疾病的检查、治疗具有重要的意义。
目前，国内外的角膜内皮细胞分析计大多是一体机，量化分析系统封闭于设备内[4]。这就
导致角膜内皮细胞健康状况的评估没有统一评价标准，不利于不同设备测量结果的横向比较，
影响了使用不同设备的用户对于角膜健康状况的准确评估。此外，在角膜内皮细胞图像中，由
于成像过程中光照不均、失焦，以及伪影等因素的干扰，导致细胞边界模糊，难以精确分割。
现有的角膜内皮细胞分析计未考虑量化结果的不确定性。
因此，本项目旨在提出了一款结合不确定性信息的角膜内皮细胞全自动定量分析系统，该
系统独立于设备，能够排除不同设备上临场参数估计算法不一致的影响，提供统一的评价标准。
除此之外，该系统中加入了角膜内皮细胞图像分割不确定信息的使用，能够展示图像分割在每
个像素位置的置信程度，为用户提供额外的可视化辅助诊断信息。
二、研究内容
基于目前已有评估系统的局限性与角膜内皮细胞分析算法的不足，我们提出了一款结合不
确定性信息的角膜内皮细胞全自动定量分析系统，使用深度学习模型完成角膜内皮细胞的自动
分割，基于分割结果对细胞密度、细胞面积变异系数、六角形细胞占比等临床参数进行自动估计。同时通过在模型中加入dropout模块，引入模型不确定性，并且应用半监督学习框架，使
用不确定性优化深度学习模型的分割精度。该系统具有以下特点：
1．自动化分割与临床参数估计。使用深度学习模型完成对角膜内皮细胞的分割，相比较
传统基于手工特征的方法更具鲁棒性，并基于分割结果对ECD、CV、HEX等临床参数进行自
动估计。
2．可视化不确定信息。在分割模型中加入dropout模块，引入模型不确定性，并对其实
现可视化，为医生展示了分割结果的置信程度，增强了人机交互性，并提高参数量化准确性。
3．独立的评估系统。该系统具有独立于设备的算法，排除了不同设备上算法不一致的影
响，提供统一的评价标准。相较于传统的一体机，一方面有利于缩短算法开发周期、降低软件
开发成本，另一方面可以更便捷地针对客户需求提供丰富的可视化分析与交互接口。
4．可灵活部署的前后端框架。采用服务器-客户端架构，在具有大算力的服务器端提供性
能更强大的模型，以得到更准确的临床参数量化与分析，该模式极大降低了客户端的算力门槛。
三、技术路线
1.优化参数估计算法
在中期答辩时，我们优化了参数估计中多边形近似。在细胞图像上，对模型的预测结果（白
色部分代表细胞边界）进行一系列后处理，最后进行单个细胞的形状估计。其中不同颜色标记
代表不同的多边形，对于角膜内皮细胞健康评估系统而言，健康的六边形细胞数量是非常重要
的参数。我们对整个后处理流程进行策略调整和优化，获得了更精确的判断。
模型预测结果 细胞形状图我们舍弃了原来的腐蚀膨胀操作，原因是在图像闭操作过程中，细胞边界曲线会进行一定
程度的偏移，对精确的细胞近似带来了干扰。
Douglas-Peucker算法
我们从模型预测结果中得到细胞边界曲线图，在细胞边界曲线图中去获取每个细胞轮廓。
基于这样的细胞轮廓，我们使用Douglas-Peucker算法进行多边形近似判断。Douglas-Peucker
算法的原理是：以AB曲线为例，将AB连成直线，设定阈值。选择离AB直线最远点C，计
算C到AB距离H。如果阈值大于H，则认为AB曲线可以近似为一条直线；小于H，则将C
设置成新的端点。重复所有上诉操作，直到轮廓所有点满足条件，细胞轮廓则近似成了某个多
边形。
​我们之前的做法是对于所有的细胞轮廓选择了相同的阈值进行多边形近似。因为细胞大
小不一致，所有细胞选取相同阈值进行估计，必然存在较大误差。我们进行多次实验以找到细
胞大小和阈值在多边形近似之间的关系。
不同大小细胞在多边形近似算法中的分析
阈值=1.5 阈值=2.0 阈值=2.5 阈值=3.0
我们通过对同一张细胞图像进行多次形状估计，通过设置不同阈值以获得不同结果，在阈值从1.5增加到3的过程中，越来越多的细胞形状被近似成了四边形。
我们根据细胞大小将细胞分成3类（以像素为单位），探究在不同阈值下细胞形状近似的
准确度。我们利用手动数据标注图，来制作正确的细胞形状图。输入相同角膜细胞图像，进行
模型预测和形状估计得到细胞形状图。每一个细胞进行颜色对比，计算得到准确度。基于上诉
实验，我们最终找到每类细胞最准确的阈值，从而设计自适应算法来完成多边形近似工作。
初始的多边形分析 优化后的多边形分析 手动标记图的多边形分析
六边形细胞数量：25 六边形细胞数量：45 六边形细胞数量：54
通过和最初版本形状估计所得的细胞形状图，对手动标记图的细胞形状图做近似对比，以
及绿色六边形细胞数量的对比，可见我们此次形状估计有了较大提升。2.优化不确定性图可视化结果
本项目使用蒙特卡洛dropout模块，当有图像输入时，dropout模块使神经元随机失效。对
于单张图像，模型对其进行十次分割，得到十张不同的分割结果。这些分割结果的均值为作为
最终分割，而它们的方差则用作估计不确定性，得到一张不确定性信息图，如下左图所示。
不确定性信息图 不确定性热力图
为了给用户更好的观感，我们使用热力图展示每个像素点的不确定性，如右上图，右
边的图标表示不同颜色代表的不确定性值。用户可以为所展示的不确定性设置了阈值，低于阈
值的不确定性将不会显示。通过设置阈值，用户可以更好的关注不确定性高的区域。
针对以上的可视化优化，我们设计了由不确定性指导的人机交互流程。对于输入的角
膜内皮细胞图像，按照一定的尺寸划分不同的区域，进行不确定性分析与计算，选择不确定性
最低的区域进行参数估计。医生可以修改不确定性的阈值，从而使程序重新对这些区域的不确
定性进行计算，得到新的分析结果。
不确定性指导的人机交互3.不确定性量化指标
从数学上看，不确定性信息的分布是一个0到0.25的矩阵。我们模型分割输出的图像
尺寸为192*192，共36864个像素点，以0.05为间隔取区间，分析不确定性在各个区间的分布，
如下图所示。因为模型分割的是细胞边界，图像中大部分区域都没有得到分割，所以不确定性
小于0.05的部分占据了大多数。使用不确定性阈值，可以过滤掉不确定性低的部分。
不确定性热力图以及对应的不确定性分布柱状图
经过不断的尝试，我们得到初步的不确定性计算公式，如下：
根据不确定性值划分不同的区间u∈U，n表示模型分割的细胞数量，I表示不确定性值大于阈
值的像素集合，
表示落在该区间u上的像素i的不确定性值。公式中，将高于阈值的值累
加，除以参数估计得到的细胞数量，得到这张图像的不确定性。同时，对于不同区间的不确定
性统计图也有助于用户修改不确定性阈值，用户可以直观得看出不确定性的值分布情况。
为了检验公式的合理性，我们挑选了TM-EM3000数据集中不同成像质量的图像进行
实验。从左往右，图像质量逐渐降低，通过公式计算的不确定性分别是7.645、5.602、4.170，
符合人眼直观感受。TM-EM3000数据集图像以及对应的不确定性热力图
由上述结果分析可知，目前所使用的不确定性计算公式能够表示热力图所展示的不确
定性信息，并且对于不同质量的图像给出不同的计算结果。
4.不确定性优化算法
使用不确定性优化算法时，借鉴该篇文章不确定性感知自我集成模型半监督学习3D
分割左心房[6]。在分割模型中引入半监督学习目的在于利用丰富的未标记数据来学习提升模
型性能，以解决医学图像已标记数据少的问题。
选择师生模型作为半监督学习方式，原因是希望图像分割预测在相同输入的不同干扰
下是一致的，这与师生模型追求一致性目的相同。我们建立了教师模型和学生模型，其中学生
模型通过最小化上标记数据的分割损失和未标记数据中与教师模型预测结果的一致性损失来
学习教师模型。由于未标记数据没有标签，教师模型的预测目标可能是不准确的。为了解决这
个问题，引入了不确定性，通过利用教师模型的不确定性信息，学生模型逐渐从有意义和可靠
的目标中学习。具体而言，教师模型除了生成未标记数据的预测结果外，还利用蒙特卡洛抽样
方法估计每个目标预测的不确定性。在计算一致性损失时，以老师模型不确定信息为指导，过滤掉不可靠的预测部分，保留可靠的(低不确定性)预测。因此，学生模型优化带来更可靠的监
督，进而鼓励教师模式产生更高质量的目标。
在角膜内皮细胞分割预测中，不确定性具体应用是以下过程。在每一次训练中，未标
记数据加入不同噪声分别输入到老师，学生模型。师生对输入图像进行预测从而得到两张分割
图，两张预测图像进行差异对比评估。与此同时老师模型将输入图像进行多次预测，用蒙特卡
洛抽样方法估计得出不确定性图，设置阈值来确定低不确定性区域。利用低不确定性区域即可
靠区域以指导学生模型学习一致性损失。
在Alizarine，Rodrep，TM-EM3000数据集下设计如下实验验证不确定性优化算法的
可行性。其中用Unet分割模型和Dropout的Unet分割模型，以及我们优化的UA-MTDropout
Unet分割模型进行Dice系数对比。Unet和DropoutUnet的测试dice系数对比证明了Dropout
的引入能够提升模型性能。不确定性优化算法目的是希望模型能够利用未标记数据学习以提升模型性能。对于
DropoutUnet我们通过控制训练集中已标记图像的数量来得到模型性能区间。以TM-EM3000
数据集为例，选取33张已标记图像作为训练集进行全监督学习训练，得到模型性能为区间下
限；154张图像作为训练集进行全监督学习训练得到的模型性能为区间上限。UA-MTDropout
Unet利用33张已标记数据和121张未标记数据进行半监督学习，由实验结果可知，其模型性
能大于DropoutUnet的模型性能区间下限，证明利用未标记数据进行了有效的学习。在三个数
据集上的实验数据充分证明了算法的可行性。
四、项目总结
本学期创新实践任务安排
阶段 时间 工作内容
第一阶段 3.7~3.31文献阅读
技术调研
第二阶段 3.31~5.5优化参数估计
优化不确定性可视化结果
第三阶段 5.5~6.5不确定性量化指标
不确定性优化算法
本学期创新实践对于设立各个阶段目标顺利实现。包括第一阶段文献调研，第二阶段
优化参数估计和优化不确定性可视化结果，第三阶段不确定性量化指标和不确定性优化算法。
对于本项目，未来我们可以从以下方面进行优化。对于输入的角膜内皮细胞图像，进行图像质
量增强和图像质量分级，以及对于参数分析结果实现智能诊断分析系统。
五、致谢
感谢刘江老师，张煜群老师，Risa老师一个学期以来提供的大量指导和帮助！
感谢张颖麟师姐等人提供的帮助与支持！